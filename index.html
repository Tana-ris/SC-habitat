<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Probability_of_occurrence.gpkg を地図に重ねて可視化</title>
  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- GeoPackage core library（ブラウザでGPKGを読むために必要）-->
  <script src="https://unpkg.com/@ngageoint/geopackage@4.2.6/dist/geopackage.min.js"></script>
  <!-- Leaflet用のGeoPackageプラグイン（URLから直接レイヤーを読み込む）-->
  <script src="https://unpkg.com/@ngageoint/leaflet-geopackage@4.1.3/dist/leaflet-geopackage.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    .leaflet-control-layers-expanded { max-height: 300px; overflow:auto; }
    .credits { position: absolute; bottom: 12px; left: 12px; background: rgba(255,255,255,.9); padding: 6px 8px; border-radius: 8px; font: 12px/1.2 system-ui, sans-serif; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="credits">データ: <code>data/Probability_of_occurrence.gpkg</code></div>

  <script>
    (async function () {
      // ===== 基本設定 =====
      const gpkgUrl = 'data/Probability_of_occurrence.gpkg'; // リポジトリの相対パス

      // GeoPackageライブラリに、WASM(sql-wasm.wasm)の取得先CDNを明示
      // GeoPackage のグローバルから、バージョン差異に対応（GeoPackageManager か GeoPackageAPI）
const { GeoPackageManager, GeoPackageAPI, setSqljsWasmLocateFile } = window.GeoPackage || {};
const GPM = GeoPackageManager || GeoPackageAPI;
if (!GPM || typeof GPM.open !== 'function') {
  console.error('window.GeoPackage keys:', window.GeoPackage && Object.keys(window.GeoPackage));
  throw new Error('GeoPackageライブラリの初期化に失敗しました（GeoPackageManager/GeoPackageAPI が見つからない）');
}
      setSqljsWasmLocateFile((filename) => `https://unpkg.com/@ngageoint/geopackage@4.2.6/dist/${filename}`);

      // ===== 地図初期化 =====
      const map = L.map('map', { center: [35.0, 135.0], zoom: 5 });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      const layersControl = L.control.layers({}, {}).addTo(map);

      // ===== GPKG の中のフィーチャテーブル名を列挙 =====
      const resp = await fetch(gpkgUrl);
      if (!resp.ok) throw new Error(`GPKGの取得に失敗しました: ${resp.status} ${resp.statusText}`);
      const arrayBuf = await resp.arrayBuffer();
      const gpkg = await GPM.open(new Uint8Array(arrayBuf));
      const featureTables = gpkg.getFeatureTables();
      if (!featureTables || featureTables.length === 0) throw new Error('このGeoPackageにフィーチャレイヤーが見つかりません');

      // テーブルごとにLeafletレイヤーを構築
      const addedLayers = [];
      const globalBounds = L.latLngBounds([]);

      for (const tableName of featureTables) {
        // 表示用レイヤ（leaflet-geopackage）: L.GeoJSON互換なのでスタイルやポップアップを設定可能
        const layer = L.geoPackageFeatureLayer([], {
          geoPackageUrl: gpkgUrl,
          layerName: tableName,
          // CircleMarkerでポイントを描画（半径や色は必要に応じて調整）
          pointToLayer: (feature, latlng) => L.circleMarker(latlng, {
            radius: 5,
            weight: 1,
            opacity: 1,
            fillOpacity: 0.7
          }),
          onEachFeature: (feature, lyr) => {
            if (feature && feature.properties) {
              const rows = Object.entries(feature.properties)
                .map(([k, v]) => `<tr><th style="text-align:left; padding-right:6px;">${k}</th><td>${v}</td></tr>`)
                .join('');
              lyr.bindPopup(`<table>${rows}</table>`);
            }
          }
        }).addTo(map);

        layersControl.addOverlay(layer, tableName);
        addedLayers.push(layer);

        // ついでに全体の表示範囲を計算（GPKGからGeoJSONをストリーミングして座標だけ拾う）
        const rs = gpkg.queryForGeoJSONFeatures(tableName);
        for (const f of rs) {
          addCoordsToBounds(f.geometry && f.geometry.coordinates, globalBounds);
        }
        rs.close();
      }

      if (globalBounds.isValid()) {
        map.fitBounds(globalBounds.pad(0.1));
      }

      gpkg.close();

      // 再帰的に座標配列からBoundsを拡張
      function addCoordsToBounds(coords, bounds) {
        if (!coords) return;
        if (typeof coords[0] === 'number') {
          // [lng, lat]
          bounds.extend([coords[1], coords[0]]);
        } else {
          for (const c of coords) addCoordsToBounds(c, bounds);
        }
      }
    })().catch((err) => {
      console.error(err);
      alert('読み込み中にエラーが発生しました。コンソールを確認してください。\n' + err.message);
    });
  </script>
</body>
</html>
