<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Probability_of_occurrence.gpkg を地図に重ねて可視化</title>
  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- GeoPackage core library（ブラウザでGPKGを読むために必要）-->
  <script src="https://unpkg.com/@ngageoint/geopackage@4.2.6/dist/geopackage.min.js"></script>
  <!-- Leaflet用のGeoPackageプラグイン（URLから直接レイヤーを読み込む）-->
  <script src="https://unpkg.com/@ngageoint/leaflet-geopackage@4.1.3/dist/leaflet-geopackage.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    .leaflet-control-layers-expanded { max-height: 300px; overflow:auto; }
    .credits { position: absolute; bottom: 12px; left: 12px; background: rgba(255,255,255,.9); padding: 6px 8px; border-radius: 8px; font: 12px/1.2 system-ui, sans-serif; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="credits">データ: <code>data/Probability_of_occurrence.gpkg</code></div>

  <script>
    (async function () {
      // ===== 基本設定 =====
      const gpkgUrl = 'data/Probability_of_occurrence.gpkg'; // リポジトリの相対パス

      // GeoPackageライブラリに、WASM(sql-wasm.wasm)の取得先CDNを明示
      // GeoPackage のグローバルから、バージョン差異に対応（GeoPackageManager か GeoPackageAPI）
const { GeoPackageManager, GeoPackageAPI, setSqljsWasmLocateFile } = window.GeoPackage || {};
const GPM = GeoPackageManager || GeoPackageAPI;
if (!GPM || typeof GPM.open !== 'function') {
  console.error('window.GeoPackage keys:', window.GeoPackage && Object.keys(window.GeoPackage));
  throw new Error('GeoPackageライブラリの初期化に失敗しました（GeoPackageManager/GeoPackageAPI が見つからない）');
}
      setSqljsWasmLocateFile((filename) => `https://unpkg.com/@ngageoint/geopackage@4.2.6/dist/${filename}`);

      // ===== 地図初期化 =====
      // 初期表示：滑川町（埼玉県）にズーム
// 参考座標（町役場付近）：36.066000, 139.360972
const map = L.map('map', { center: [36.066000, 139.360972], zoom: 13 });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      const layersControl = L.control.layers({}, {}).addTo(map);

      // ===== GPKG の中のフィーチャテーブル名を列挙 =====
      const resp = await fetch(gpkgUrl);
      if (!resp.ok) throw new Error(`GPKGの取得に失敗しました: ${resp.status} ${resp.statusText}`);
      const arrayBuf = await resp.arrayBuffer();
      const gpkg = await GPM.open(new Uint8Array(arrayBuf));
      const featureTables = gpkg.getFeatureTables();
      if (!featureTables || featureTables.length === 0) throw new Error('このGeoPackageにフィーチャレイヤーが見つかりません');

      // テーブルごとにLeafletレイヤーを構築
      const addedLayers = [];
      const globalBounds = L.latLngBounds([]);

      // === クリック時に ID を使って PNG を表示する（固定拡張子 .png） ===
      function buildPngPopupHtml(id, url) {
        return `<div class="wf-pop"><img src="${url}" alt="waterfall_ID${id}_RF" style="max-width:300px;max-height:300px;display:block" /><div style="margin-top:4px;"><a target="_blank" href="${url}">新しいタブで開く</a></div></div>`;
      }
      async function handleWaterfallClick(feature, ev) {
        const props = (feature && feature.properties) || {};
        const id = props.ID ?? props.id ?? props.Id;
        const popup = L.popup({ maxWidth: 420 }).setLatLng(ev.latlng).setContent('読み込み中...').openOn(map);
        if (id == null) {
          popup.setContent('このポイントに ID 属性がありません。');
          return;
        }
        const url = `data/waterfall/waterfall_ID${id}_RF.png`;
        // 画像の存在確認とロード（HEADは使わず、Imageオブジェクトで確認）
        const img = new Image();
        img.onload = () => {
          popup.setContent(buildPngPopupHtml(id, url));
        };
        img.onerror = () => {
          popup.setContent(`ファイルが見つかりません：<code>${url}</code>`);
        };
        img.src = url;
      }

      

      for (const tableName of featureTables) {
        // 表示用レイヤ（leaflet-geopackage）: L.GeoJSON互換なのでスタイルやポップアップを設定可能
        const layer = L.geoPackageFeatureLayer([], {
          geoPackageUrl: gpkgUrl,
          layerName: tableName,
          // CircleMarkerでポイントを描画（半径や色は必要に応じて調整）
          pointToLayer: (feature, latlng) => L.circleMarker(latlng, {
            radius: 5,
            weight: 1,
            opacity: 1,
            fillOpacity: 0.7
          }),
          onEachFeature: (feature, lyr) => {
            // クリックで ID を参照し、data/waterfall/waterfall_ID{ID}_RF.png を表示
            lyr.on('click', (ev) => handleWaterfallClick(feature, ev));

            // 表示範囲の更新（ポイント/ライン/ポリゴン対応）
            try {
              if (typeof lyr.getLatLng === 'function') {
                globalBounds.extend(lyr.getLatLng());
              } else if (typeof lyr.getBounds === 'function') {
                globalBounds.extend(lyr.getBounds());
              }
            } catch (e) { /* noop */ }
          }
        }).addTo(map);

        layersControl.addOverlay(layer, tableName);
        addedLayers.push(layer);

        // 以前は gpkg.queryForGeoJSONFeatures(...) を使ってboundsを計算していましたが
        // バージョン差で未実装なため、onEachFeatureで随時globalBoundsを更新する方式に変更しました。
      }

      // 自動フィットは無効化（初期ズームは滑川町のまま）。
      // 必要なら下のコメントを外して、データ全体にフィットさせられます。
      // if (globalBounds.isValid()) {
      //   map.fitBounds(globalBounds.pad(0.1));
      // }

      gpkg.close();

      // 再帰的に座標配列からBoundsを拡張
      function addCoordsToBounds(coords, bounds) {
        if (!coords) return;
        if (typeof coords[0] === 'number') {
          // [lng, lat]
          bounds.extend([coords[1], coords[0]]);
        } else {
          for (const c of coords) addCoordsToBounds(c, bounds);
        }
      }
    })().catch((err) => {
      console.error(err);
      alert('読み込み中にエラーが発生しました。コンソールを確認してください。\n' + err.message);
    });
  </script>
</body>
</html>
