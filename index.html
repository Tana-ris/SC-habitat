<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Probability_of_occurrence.gpkg を地図に重ねて可視化</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- GeoPackage（ブラウザでGPKGを読むために必要）-->
  <script src="https://unpkg.com/@ngageoint/geopackage@4.2.6/dist/geopackage.min.js"></script>
  <!-- Leaflet用のGeoPackageプラグイン（URLから直接レイヤーを読み込む）-->
  <script src="https://unpkg.com/@ngageoint/leaflet-geopackage@4.1.3/dist/leaflet-geopackage.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    .leaflet-control-layers-expanded { max-height: 300px; overflow: auto; }
    .credits {
      position: absolute; bottom: 12px; left: 12px;
      background: rgba(255,255,255,.9); padding: 6px 8px;
      border-radius: 8px; font: 12px/1.2 system-ui, sans-serif;
      z-index: 500;
    }

    /* ===== ポップアップ（大きめ＆はみ出し防止） ===== */
    .wf-popup .leaflet-popup-content-wrapper {
      border-radius: 12px;
      overflow: hidden;
    }
    .wf-popup .leaflet-popup-content {
      box-sizing: border-box;
      width: clamp(280px, 60vw, 960px);
      height: clamp(260px, 60vh, 720px);
      margin: 8px 10px;
      overflow: hidden;
    }
    @supports (height: 100dvh) {
      .wf-popup .leaflet-popup-content { height: clamp(260px, 60dvh, 720px); }
    }

    /* ポップアップ内部 */
    .wf-pop {
      width: 100%; height: 100%;
      display: flex; flex-direction: column; gap: 8px;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
    }
    .wf-prob {
      font-size: clamp(16px, 2vw, 22px); /* 大きく */
      line-height: 1.4;
      font-weight: 700;
      text-align: center;               /* 中央寄せ */
      white-space: normal; overflow-wrap: anywhere; word-break: break-word;
      padding: 6px 8px;
      background: rgba(0,0,0,.03);
      border-radius: 6px;
    }
    .wf-img-wrap {
      flex: 1 1 auto;
      min-height: 0;
      display: flex; align-items: center; justify-content: center;
      border: 1px solid rgba(0,0,0,.08); border-radius: 8px;
      background: #fff;
    }
    .wf-img {
      width: 100%; height: 100%;
      object-fit: contain;
      display: block;
    }
    .wf-link {
      margin-top: 2px;
      font-size: clamp(14px, 1.6vw, 18px); /* 少し大きく */
      font-weight: 700;
      text-align: center;                  /* 中央寄せ */
    }
    .wf-link a { text-decoration: underline; }

    /* ✖ボタンを大きく */
    .wf-popup .leaflet-popup-close-button {
      width: 28px; height: 28px;
      line-height: 28px; font-size: 18px; font-weight: 800;
      color: #fff; background: rgba(0,0,0,.65);
      border-radius: 999px;
      top: 6px; right: 6px;
    }
    .wf-popup .leaflet-popup-close-button:hover { background: rgba(0,0,0,.8); }

    /* ===== レジェンド ===== */
    .wf-legend.leaflet-control {
      background: rgba(255,255,255,.95);
      padding: 8px 10px; border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,.12);
      font: 12px/1.3 system-ui, sans-serif;
    }
    .wf-legend h4 { margin: 0 0 6px; font-size: 12px; }
    .wf-legend .item { display: flex; align-items: center; gap: 6px; margin: 2px 0; }
    .wf-legend .swatch { width: 14px; height: 14px; border-radius: 3px; border: 1px solid rgba(0,0,0,.15); }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="credits">データ: <code>data/Probability_of_occurrence.gpkg</code></div>

  <script>
    (async function () {
      // ===== 設定 =====
      const gpkgUrl = 'data/Probability_of_occurrence.gpkg';

      // 多言語（日本語/英語）
      const I18N = {
        ja: { probLabel: '生息確率', propKey: 'Probability', open: '画像を新しいタブで開く' },
        en: { probLabel: 'Probability　of　occurrence', propKey: 'Probability', open: 'Open image in a new tab' },
      };
      const LANG = 'en'; // 'en' にすると英語表記

      // GeoPackage 初期化
      const { GeoPackageManager, GeoPackageAPI, setSqljsWasmLocateFile } = window.GeoPackage || {};
      const GPM = GeoPackageManager || GeoPackageAPI;
      if (!GPM || typeof GPM.open !== 'function') {
        console.error('window.GeoPackage keys:', window.GeoPackage && Object.keys(window.GeoPackage));
        throw new Error('GeoPackageライブラリの初期化に失敗しました（GeoPackageManager/GeoPackageAPI が見つからない）');
      }
      setSqljsWasmLocateFile((filename) => `https://unpkg.com/@ngageoint/geopackage@4.2.6/dist/${filename}`);

      // ===== 地図初期化（滑川町周辺） =====
      const map = L.map('map', { center: [36.066000, 139.360972], zoom: 14 });

      // ベースレイヤー
      const baseLayers = {
        'OpenStreetMap': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }),
        'GSI 標準地図': L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
          maxZoom: 18,
          attribution: '&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">GSI</a>'
        }),
        'GSI 淡色地図': L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
          maxZoom: 18,
          attribution: '&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">GSI</a>'
        }),
        'OpenTopoMap': L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
          maxZoom: 17,
          attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/">OSM</a>, SRTM | Tiles: &copy; OpenTopoMap'
        }),
        'Esri 衛星（World Imagery）': L.tileLayer(
          'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
          {
            maxZoom: 19,
            attribution: 'Tiles &copy; Esri — Source: Esri, Maxar, Earthstar Geographics, and the GIS User Community'
          }
        )
      };
      baseLayers['GSI 標準地図'].addTo(map);

      const overlayLayers = {};
      const layersControl = L.control.layers(baseLayers, overlayLayers, { collapsed: false }).addTo(map);

      // ===== GPKG 読み込み =====
      const resp = await fetch(gpkgUrl);
      if (!resp.ok) throw new Error(`GPKGの取得に失敗しました: ${resp.status} ${resp.statusText}`);
      const arrayBuf = await resp.arrayBuffer();
      const gpkg = await GPM.open(new Uint8Array(arrayBuf));
      const featureTables = gpkg.getFeatureTables();
      if (!featureTables || featureTables.length === 0) throw new Error('このGeoPackageにフィーチャレイヤーが見つかりません');

      // ===== 値の取得と整形 =====
      function getProbAsPercent(props) {
        // 候補キー（綴り揺れ対応）
        const cand = ['Probablity','Probability','probability','PROBABILITY','prob','value'];
        let v = null;
        for (const key of cand) {
          if (props && Object.prototype.hasOwnProperty.call(props, key)) {
            v = Number(props[key]); break;
          }
        }
        if (!isFinite(v)) return null;
        if (v >= 0 && v <= 1) return v * 100;   // 0-1 → %
        if (v > 1 && v <= 100) return v;        // 1-100 → そのまま %
        return null;
      }

      // ===== 等級色（10–80 を 10刻みの 7段 + 外れ値） =====
      // クラス: <10, 10–20, 20–30, 30–40, 40–50, 50–60, 60–70, 70–80, >80
      const colorBelow = '#e0e0e0';  // <10
      const colorAbove = '#4a1486';  // >80
      const ramp = [
        '#fff7bc', // 10–20
        '#fee391', // 20–30
        '#fec44f', // 30–40
        '#fe9929', // 40–50
        '#ec7014', // 50–60
        '#cc4c02', // 60–70
        '#993404', // 70–80
      ];
      function colorForPercent(p) {
        if (p == null) return '#9e9e9e';
        if (p < 10)  return colorBelow;
        if (p <= 20) return ramp[0];
        if (p <= 30) return ramp[1];
        if (p <= 40) return ramp[2];
        if (p <= 50) return ramp[3];
        if (p <= 60) return ramp[4];
        if (p <= 70) return ramp[5];
        if (p <= 80) return ramp[6];
        return colorAbove;
      }

      // ===== ポップアップHTML =====
      const formatProbabilityText = (v) => (v == null ? '—' : (v.toFixed(1) + '%'));
      const buildPngPopupHtml = (probText, url, id, lang = 'ja') => {
        const t = I18N[lang] ?? I18N.ja;
        return `
          <div class="wf-pop">
            <div class="wf-prob">${t.probLabel}（<code>${t.propKey}</code>）: <strong>${probText}</strong></div>
            <div class="wf-link"><a target="_blank" rel="noopener noreferrer" href="${url}">${t.open}</a></div>
            <div class="wf-img-wrap">
              <img class="wf-img" decoding="async" loading="lazy" src="${url}" alt="waterfall_ID${id}_RF" />
            </div>
          </div>
        `;
      };

      async function handleWaterfallClick(feature, ev) {
        const props = (feature && feature.properties) || {};
        const id = props.ID ?? props.id ?? props.Id;
        const p = getProbAsPercent(props);
        const probText = formatProbabilityText(p);

        const popup = L.popup({
          maxWidth: Math.min(960, Math.floor(window.innerWidth * 0.9)),
          className: 'wf-popup',
          autoPan: true,
          keepInView: true,
          autoPanPadding: [30, 30]
        }).setLatLng(ev.latlng).setContent('読み込み中...').openOn(map);

        if (id == null) {
          popup.setContent('このポイントに ID 属性がありません。');
          return;
        }

        const url = `data/waterfall/waterfall_ID${id}_RF.png`;

        const img = new Image();
        img.onload = () => { popup.setContent(buildPngPopupHtml(probText, url, id, LANG)); };
        img.onerror = () => { popup.setContent(`ファイルが見つかりません：<code>${url}</code>`); };
        img.src = url;
      }

      // ===== レイヤー追加（ポイントサイズ↑・枠線は白） =====
      for (const tableName of featureTables) {
        const layer = L.geoPackageFeatureLayer([], {
          geoPackageUrl: gpkgUrl,
          layerName: tableName,
          pointToLayer: (feature, latlng) => {
            const p = getProbAsPercent(feature.properties);
            return L.circleMarker(latlng, {
              radius: 8,          // ← 少し大きく
              weight: 2,          // 枠線太さ
              opacity: 1,
              color: '#ffffff',   // ← 枠線は白
              fillOpacity: 0.9,
              fillColor: colorForPercent(p)
            });
          },
          onEachFeature: (feature, lyr) => {
            lyr.on('click', (ev) => handleWaterfallClick(feature, ev));
          }
        }).addTo(map);

        overlayLayers[tableName] = layer;
        layersControl.addOverlay(layer, tableName);
      }

      // ===== レジェンド =====
      const legend = L.control({ position: 'bottomright' });
      legend.onAdd = function () {
        const div = L.DomUtil.create('div', 'wf-legend');
        const items = [];
        items.push('<h4>値（%）</h4>');
        items.push(`<div class="item"><span class="swatch" style="background:${colorBelow}"></span><span>&lt; 10</span></div>`);
        items.push(`<div class="item"><span class="swatch" style="background:${ramp[0]}"></span><span>10–20</span></div>`);
        items.push(`<div class="item"><span class="swatch" style="background:${ramp[1]}"></span><span>20–30</span></div>`);
        items.push(`<div class="item"><span class="swatch" style="background:${ramp[2]}"></span><span>30–40</span></div>`);
        items.push(`<div class="item"><span class="swatch" style="background:${ramp[3]}"></span><span>40–50</span></div>`);
        items.push(`<div class="item"><span class="swatch" style="background:${ramp[4]}"></span><span>50–60</span></div>`);
        items.push(`<div class="item"><span class="swatch" style="background:${ramp[5]}"></span><span>60–70</span></div>`);
        items.push(`<div class="item"><span class="swatch" style="background:${ramp[6]}"></span><span>70–80</span></div>`);
        items.push(`<div class="item"><span class="swatch" style="background:${colorAbove}"></span><span>&gt; 80</span></div>`);
        div.innerHTML = items.join('');
        L.D
omEvent.disableClickPropagation(div);
        return div;
      };
      legend.addTo(map);

      gpkg.close();
    })().catch((err) => {
      console.error(err);
      alert('読み込み中にエラーが発生しました。コンソールを確認してください。\n' + err.message);
    });
  </script>
</body>
</html>
